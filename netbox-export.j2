[
{% set ns = namespace(first=true) %}
{% for vm in queryset %}
  {% if (vm.status == 'active' or vm.status == 'paused') and 'vm' in vm.custom_field_data.VMorContainer %}

    {% set context = vm.get_config_context() %}
    {% set vars = namespace(vlan=0, net1_ip="") %}
    
{%- set network_interfaces = [] -%}
    
    {# 1. Try to get the Primary Interface via the Primary IP link #}
    {%- if vm.primary_ip and vm.primary_ip.assigned_object -%}
      {%- set i = vm.primary_ip.assigned_object -%}
      {%- set i_data = {
        "name": i.name | string,
        "vlan": i.untagged_vlan.vid if i.untagged_vlan else 0,
        "ip": vm.primary_ip.address | string,
        "is_primary": true
      } -%}
      {%- set network_interfaces = network_interfaces + [i_data] -%}
    {%- endif -%}

    {# 2. Fallback: If no interfaces found yet, try the 'interfaces' manager one last way #}
    {%- if network_interfaces | length == 0 -%}
      {%- for i in vm.interfaces.all() -%}
         {%- set network_interfaces = network_interfaces + [{"name": i.name | string, "is_primary": false}] -%}
      {%- endfor -%}
    {%- endif -%}

    {
      {# Basic variables #}
      "name": "{{ vm.name }}",
      "status": "{{ 'running' if vm.status == 'active' else 'stopped' }}",
      "ssh_keys": "{{ context.ssh_keys | join('\\n') if context.ssh_keys else '' }}",
      "vmid": {{ vm.custom_field_data.vmid or 0 }},
      "desc": "{{ vm.comments | replace('\n', ' ') | replace('"', '\\"') or 'Managed by NetBox' }}",
      "node": "{{ vm.device.name if vm.device else (vm.cluster.name if vm.cluster else 'pve') }}",
      "cores": {{ vm.vcpus | int if vm.vcpus else 1 }},
      "memory": {{ vm.memory or 1024 }},
      "storage": "{{ vm.custom_field_data.storage_location or 'local-zfs' }}",
      "disk_size": "{{ (vm.disk / 1000) | int if vm.disk else 8 }}G",
      "pool": "{{ vm.custom_field_data.proxmox_pool or '' }}",
      "start_at_node_boot": {{ "true" if vm.start_on_boot == "on" else "false" }},
      "interfaces": {{ network_interfaces | tojson }}, 


      {# Image Logic #}
      {%- if vm.custom_field_data.prod_image -%}
        {%- set img = vm.custom_field_data.prod_image -%}
      {%- elif vm.custom_field_data.template == "ubuntu-2204-cloud" -%}
        {%- set img = "ubuntu-cloud" -%}
      {% else -%}
        {% set img = vm.custom_field_data.template or "ubuntu-cloud" %}
      {%- endif -%}
      "image": "{{ img }}",
      "tags": "{{ vm.tags.all() | join(',') }}"
    }

    {# Important: adds a comma after every entry except the last for valid JSON #}
    {{ "," if not loop.last }}

  {% endif %}
{% endfor %}
]