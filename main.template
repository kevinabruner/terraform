terraform {
  required_providers {
    proxmox = {
      source = "telmate/proxmox"
      version = "3.0.1-rc1"
    }
  }
}
  


provider "proxmox" {  
  pm_api_url = "https://pve.thejfk.ca/api2/json"    
  pm_api_token_id = "terraform@pam!main_terraform"    
  pm_api_token_secret = "b01b0155-c025-4b3a-b173-cb6b1bf9eb17"    
  pm_tls_insecure = false
}




/* Configure Cloud-Init User-Data with custom config file */
resource "proxmox_vm_qemu" @@@vm_name {  
  count     = @@@count
  vmid        = var.vmid
  name        = var.vm_name
  desc        = "tf description"
  target_node = var.pve_node
  agent       = 1

  clone = "ubuntu-cloud"
  full_clone = true

  # The destination resource pool for the new VM
#  pool = var.vm_pool

  
  ##Add this back in for additional storage!!!!
  #disks {    
  #  virtio{
  #    virtio1{
  #      disk{                
  #        backup = true          
  #        size = var.storage
  #        storage = "ceph"
  #      }
  #    }
  #  }    
  #}

  
  scsihw  = "virtio-scsi-pci"
  bootdisk = "scsi0"
  cores   = var.cores
  sockets = 1
  memory  = var.memory  

  network {    
    model = "virtio"
    macaddr = var.vm_macaddr
    bridge  = "vmbr0"
    @@@vlan
  }
  

  ###hard-coding for now, will have unique per vm later
  define_connection_info = true
  ssh_user        = "kevin"
  ssh_private_key = <<EOF
  -----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----

  EOF
  
  


  sshkeys = <<EOT
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC5ISFOmXHsV1fZgbW6I7lSXRW4ScxMR+bUbAD+hUbXnfHJ3mJ7e3jl6OGhpQxwecZRdiA96fgTazM48plO7qqAj3/UmOgH87oI4WYuNm5UK2NSLqlfikbYDGqdD3qrdG5vSrpmcNPGLTDgKcWV8UwfDJ2uyBXJ5byXu9mXHjbyHzFiCoQYHicQ617cXB0qtvORRrUw3nhahL25nxJSHwCA5YbHovmFHsG5Y9xV3nNGHLZq+2fnc6gPL5CZvWhJWLUhlKpS3hbfYJWsIH0Ssj1JzHW9fuBINq+eGE9KTn9TKy/pY00VwIlom7i9mybtIkTFsYgvKTASGn8t9nv2QBLezSCcMzudW8mSLQp6mi8W1a7gQ1iM+3nPYj/f2o5bQMUkrUnGAET64iKGyxQ85NyeLwyAaChdoStx7viyN5Z36j+3kTLCzNbfaJANk168ouj/NcUnNrC390GSEXdB1oF9v7S8atZ1TXKuzsykH1tb3h4mh/hORtcGKfEfQ1w9sZk= kevin@bessie
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDCfKdycPd96nMVRwU166yImlMSlgjlClJP/JpDx6fUx4xECkpxfiRWyBELTmyFp1loC0ABLL6p86GQEeriABsuOkb9zwOiUTxvJEfwuVPKULvE3kt0nZrQQd0KpGFZ2qbhlTNAUVshU0eYGONevh9AwvjkGLZxakiwIl0XF1X/RzbotYmT7D4hA7yy2/8I97hMTL7a5xSLNMJpfd6rNzq9GwX/o4b06iJjlkyMmgUJevWst4ATb9XAgkJwuuPjXM9dSJi5MwjWYkwH0zCJvutPJ5Z28oy7M1R3+oCbGh+7xNmcOhrCcceV4Z5sq3uYOy/kRR3osCU2pFgirs9TxPwqLHTTiPlcxOvAaACNK9tQDSqI+XwNecBKt4NgvbavI4WgcilqAe3lmUlMskJllEwUi3QrnSGP53LaHu2PRxrPTLfLZI5DKReKzB29FE7ZsMiOCbcTB4SJrBRmxfVB7VSNepqqmLh3RyHb0vRWidKshsz9PXb1Zynpn7nGcbMKxFE= kevin@ansible
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCqAJpgMNAvZsnnWEfg4vqU0LpmhNYN1+Pv9D8op3EGrCUHCmLAE9ur732ycHxBr7oKCe/G4xIV/kHivQglkGT0RrFdSNs5JY8gNo/CRICFVLsuBJPftX6b7pBdpIiEcvUugeqMJccxZ34fkiqE+z78v1T4vYSfTJwdRIiT243vJ/DxxLma3XyJgZTPi+2YTKYGKQsIHYicVeR838+mA/4hpTnRc0Oxqn1JPurhQ5wPptlUgpQCY5wGWn2Y17E8SnOmLq303SIvFdYAwZ8rxNJGm+vMuO4sUibcU4gszKI+wUR8lZtdQ2PihbHCxxF0RRtZIVYxZuy2KJsDsu2NRIxNgTU2k+Op+3igGYckYG2eJ814qScUL/KC3HcpBX2S808sT1QwfI4CxL0C3TWYKLsKqJWHLRahbnd6XPMRwi6EXrFxg5qWDD+RgWUND2Gr+2L2dTST8bvDehWbwUA+DeF2pMMT/QT1E7N9Dv71x+nx2MmiFKku9b8uA/AnngUKBn0= kevin@terraform
  EOT

  

  os_type   = "ubuntu"
  ipconfig0 = "ip=${var.vm_ip},gw=${var.vm_gw}"

  /*
    sshkeys and other User-Data parameters are specified with a custom config file.
    In this example each VM has its own config file, previously generated and uploaded to
    the snippets folder in the local storage in the Proxmox VE server.
  */  
  /* Create the Cloud-Init drive on the "local-lvm" storage */
  cloudinit_cdrom_storage = "ceph"


}





