terraform {
  required_providers {
    proxmox = {
      source = "telmate/proxmox"
      version = "3.0.1-rc1"
    }
  }
}
  


provider "proxmox" {  
  pm_api_url = "https://pve.thejfk.ca/api2/json"    
  pm_api_token_id = "terraform@pam!main_terraform"    
  pm_api_token_secret = "b01b0155-c025-4b3a-b173-cb6b1bf9eb17"    
  pm_tls_insecure = false
}




/* Configure Cloud-Init User-Data with custom config file */
resource "proxmox_vm_qemu" @@@vm_name {  
  count     = @@@count
  vmid        = var.vmid
  name        = var.vm_name
  desc        = "tf description"
  target_node = var.pve_node
  agent       = 1

  clone = "ubuntu-cloud"
  full_clone = true

  # The destination resource pool for the new VM
#  pool = var.vm_pool

  disks {    
    virtio{
      virtio1{
        disk{                
          backup = true          
          size = var.storage
          storage = "ceph"
        }
      }
    }    
  }

  
  scsihw  = "virtio-scsi-pci"
  bootdisk = "scsi0"
  cores   = var.cores
  sockets = 1
  memory  = var.memory  

  network {    
    model = "virtio"
    bridge  = "vmbr0"
    @@@vlan
    link_down = false
  }
  
  
  

  ssh_user        = "root"
  ssh_private_key = <<EOF
-----BEGIN RSA PRIVATE KEY-----
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

-----END RSA PRIVATE KEY-----
EOF


  sshkeys = <<EOT
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC5ISFOmXHsV1fZgbW6I7lSXRW4ScxMR+bUbAD+hUbXnfHJ3mJ7e3jl6OGhpQxwecZRdiA96fgTazM48plO7qqAj3/UmOgH87oI4WYuNm5UK2NSLqlfikbYDGqdD3qrdG5vSrpmcNPGLTDgKcWV8UwfDJ2uyBXJ5byXu9mXHjbyHzFiCoQYHicQ617cXB0qtvORRrUw3nhahL25nxJSHwCA5YbHovmFHsG5Y9xV3nNGHLZq+2fnc6gPL5CZvWhJWLUhlKpS3hbfYJWsIH0Ssj1JzHW9fuBINq+eGE9KTn9TKy/pY00VwIlom7i9mybtIkTFsYgvKTASGn8t9nv2QBLezSCcMzudW8mSLQp6mi8W1a7gQ1iM+3nPYj/f2o5bQMUkrUnGAET64iKGyxQ85NyeLwyAaChdoStx7viyN5Z36j+3kTLCzNbfaJANk168ouj/NcUnNrC390GSEXdB1oF9v7S8atZ1TXKuzsykH1tb3h4mh/hORtcGKfEfQ1w9sZk= kevin@bessie
  EOT

  

  os_type   = "ubuntu"
  ipconfig0 = "ip=${var.vm_ip},gw=${var.vm_gw}"

  /*
    sshkeys and other User-Data parameters are specified with a custom config file.
    In this example each VM has its own config file, previously generated and uploaded to
    the snippets folder in the local storage in the Proxmox VE server.
  */  
  /* Create the Cloud-Init drive on the "local-lvm" storage */
  cloudinit_cdrom_storage = "ceph"

  provisioner "remote-exec" {
    inline = [
      "pve.jfkhome"
    ]
  }
}





